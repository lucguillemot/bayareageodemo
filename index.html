<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1">

    <title>SFBA OAC</title>
    <!-- JQuery -->
    <script src="layout/jquery-2.2.0.min.js"></script>
    <!-- Bootstrap -->
    <link href="layout/bootstrap-3.3.6-dist/css/bootstrap.min.css" rel="stylesheet">
    <script src="layout/bootstrap-3.3.6-dist/js/bootstrap.min.js"></script>
    <!-- leaflet -->
    <link rel="stylesheet" href="layout/leaflet-0.7.3/leaflet.css" />
    <script src="layout/leaflet-0.7.3/leaflet.js"></script>
    <!-- d3 and plugins -->
    <script src="layout/d3-master/d3.min.js"></script>
    <script src="layout/queue.js"></script>
    <script src="layout/topojson.js"></script>
    <script src="layout/radarPlot.js"></script>
    <script src="layout/sankey.js"></script>
    <!-- custom css -->
    <link rel="stylesheet" href="layout/css/main.css" /> 
    <link rel="stylesheet" href="layout/css/sankey.css" />   
  </head>
  
  <body>
      <!-- <div class="row">
      <div class="col-xs-7">
        <div id="sankey"></div>
      </div>
      <div class="col-xs-5">
      </div>
    </div> -->
<!-- <div class="row top-buffer">
      <div class="col-xs-7">
        <div class="btn-toolbar" role="toolbar" aria-label="...">
          <div class="btn-group btn-group-sm" role="group" aria-label="...">
            <button type="button" class="btn btn-default">1. Wealthy Surbanites</button>
            <button type="button" class="btn btn-default">2. Urban Diversity</button>
            <button type="button" class="btn btn-default">3. Working Urbanites</button>
            <button type="button" class="btn btn-default">4. Struggling Urbanites</button>
            <button type="button" class="btn btn-default">5. Secluded Urbanites</button>
            <button type="button" class="btn btn-default">6. Young and Lively Urbanites</button>
            <button type="button" class="btn btn-default">7. Subarbanites</button>
            <button type="button" class="btn btn-default">8. Remote Surbanites</button>
            <button type="button" class="btn btn-default">9. Berkeley</button>
            <button type="button" class="btn btn-default">10. Weird Cluster</button>
          </div>
        </div>
      </div>
    </div> -->
    <!--  -->

  <div class="container title">
    <h1>Bay Area Geodemographics<br><small>Tracking change in San Francisco Bay Area Neighborhoods</small></h1>
  </div>

  <div class="container">
    <div class="row top-buffer">
      <div class="col-xs-3">
        <div class="btn-toolbar" role="toolbar" aria-label="...">
          <div class="btn-group btn-group-sm" role="group" aria-label="...">
            <button type="button" class="btn btn-default btn-clusters btn-display active" value="clusters" aria-pressed="true">Clusters</button>
            <button type="button" class="btn btn-default btn-change btn-display" value="change">Change</button>
            <button type="button" class="btn btn-default btn-variables btn-display" value="variables">Raw variables</button>
          </div>
        </div>
      </div>
      <div class="col-xs-4">
        <div class="btn-toolbar" role="toolbar" aria-label="...">
          <div class="btn-group btn-group-sm" role="group" aria-label="...">
            <button type="button" class="btn btn-default btn-years" value="2009">2009</button>
            <button type="button" class="btn btn-default btn-years" value="2010">2010</button>
            <button type="button" class="btn btn-default btn-years" value="2011">2011</button>
            <button type="button" class="btn btn-default btn-years" value="2012">2012</button>
            <button type="button" class="btn btn-default btn-years" value="2013">2013</button>
            <button type="button" class="btn btn-default btn-years active" value="2014" aria-pressed="true">2014</button>
          </div>
        </div>
      </div>
    </div>

    <div class="row top-buffer">
      <div class="col-xs-6">
        <div id="map"></div>
      </div>
      <div class="col-xs-2">
        <div id="cluster-legend-label"></div>
        <div id="variable-legend-label"></div>
      </div>
      <div class="col-xs-4">
        <div id="radarChart"></div>
        <div id="distributionPlot"></div>
        <div id="variable-legend-color-scale"></div>
      </div>
    </div>

   <!--  <div class="row top-buffer">
      <div class="col-xs-2">
          <p>Standardization:</p>
          <div class="btn-toolbar" role="toolbar" aria-label="...">
          <div class="btn-group btn-group-sm" role="group" aria-label="...">
            <button type="button" class="btn btn-default">square root</button>
            <button type="button" class="btn btn-default">log</button>
            <button type="button" class="btn btn-default">IHS</button>
          </div>
        </div>
      </div>
      <div class="col-xs-2">
        <p>Clustering algorithm:</p>
        <div class="btn-toolbar" role="toolbar" aria-label="...">
          <div class="btn-group btn-group-sm" role="group" aria-label="...">
            <button type="button" class="btn btn-default btn-algo active" value="hclust" aria-pressed="true">h. clustering</button>
            <button type="button" class="btn btn-default btn-algo" value="kmeans">k-means</button>
          </div>
        </div>
      </div>
    </div>
    <div class="row top-buffer">
      <div class="col-xs-3">
        <p>Number of clusters:</p>
        <div class="btn-toolbar" role="toolbar" aria-label="...">
          <div class="btn-group btn-group-sm" role="group" aria-label="...">
            <button type="button" class="btn btn-default btn-nclass" value="8">8</button>
            <button type="button" class="btn btn-default btn-nclass" value="9">9</button>
            <button type="button" class="btn btn-default btn-nclass" value="10">10</button>
            <button type="button" class="btn btn-default btn-nclass" value="11">11</button>
            <button type="button" class="btn btn-default btn-nclass" value="12">12</button>
            <button type="button" class="btn btn-default btn-nclass" value="13">13</button>
            <button type="button" class="btn btn-default btn-nclass" value="14">14</button>
            <button type="button" class="btn btn-default btn-nclass active" value="15" aria-pressed="true">15</button>
          </div>
        </div>
      </div>  
      <div class="col-xs-3">
        <p>Linkage:</p>
        <div class="btn-toolbar" role="toolbar" aria-label="...">
          <div class="btn-group btn-group-sm" role="group" aria-label="...">
            <button type="button" class="btn btn-default btn-linkage" value="single">single</button>
            <button type="button" class="btn btn-default btn-linkage" value="average">average</button>
            <button type="button" class="btn btn-default btn-linkage active" value="complete" aria-pressed="true">complete</button>
          </div>
        </div>
      </div>    
    </div> -->

    <div class="row top-buffer">
      <div class="col-xs-6">

        <h2>About</h2>
        <p>Hierachical Clustering, complete linkage, 15 clusters, temporal.</p>
      </div>
    </div>

  </div>

  <script>
  // global variables
  var Format = d3.format("%");
  var clusterById = {};
  var variablesById = {};
  var currentYear = "2014";
  var currentCluster = 1;
  var currentLinkage = "complete";
  var currentNClass = 15;
  var opacity = "off";
  var currentDisplay = "clusters";
  var currentVariable = "PCcommutingNotCar";
  var years = ["2009","2010","2011","2012","2013","2014"];
  // Clusters colors and labels
  var colors = ["#18154C","#EC501C","#7F1B4F","#005C37","#1A86C3","#E71584","#4F3089","#FEF30C","#E6211C","#17ABA1", "#b15928", "#f69c45", "#bb5fa1", "#000000", "#b0c1c9"]; 
  var clusters_labels = ["1. Wealthy educated surburbs & sparsely pop. city areas", "2. Long-time and newly privileged city areas", "3. Struggling, less educated black urban areas", "4. Young & very urban diversity", "5. Very urban, racially diverse but strugging", "6. Less dense, lower middle-class", "7. Poor, dense, urban but secluded", "8. Less dense white middle-class", "9. Urban less educated black & latino", "10. OUTLIER: very black", "11. OUTLIER: very dense & very poor", "12. Mostly asian suburban areas", "13. OUTLIER: Seniors resort", "14. OUTLIER", "15. OUTLIER: Air force base"];
  // variables colors and labels
  var variables_names = ["density","PConeUnit","PCcommutingNotCar","PClessHighSchool","PCsomeCollegeOrMore","PCdoctorate","PCmarriedCouple","PCwithKids","PCunmarriedSSCouple","PCsexMale","medianAge","PCraceWhiteAlone","PCraceBlackAlone","PCraceAsianAlone","PCraceHispanic","PCforeignBorn","PCownerOccUnits","PCwithInterests","perCapitaIncome","PCunemployed","PCpoorStruggling","PCveryWealthyHHolds"];
  var variables_labels = ["Density", "One Unit","Public Transit", "Less than High School","Some college", "PhD holder","Married couple", "With kids","Same-sex couples", "Males","Median age", "Whites","Blacks", "Asian","Hispanic", "Foreign-born","Owner-occupied", "With interests","Per capita income", "Unemployment","Poor and Struggling", "Very wealthy"]
  var variable_color_scale = ["#f7fbff","#deebf7","#c6dbef","#9ecae1","#6baed6","#4292c6","#2171b5","#08519c","#08306b", "#052043"]
  var variable_domain = [0.1, 0.2, 0.3, 0.4, 0.5, 0.6, 0.7, 0.8, 0.9];

  ////////////////////////////////////////////////////////////////////
  // MAP INITIAL DISPLAY /////////////////////////////////////////////

  // Map Bay Area parameters
  //var map = new L.Map('map').setView([37.8082, -122.2668], 10 ); 

  // Map San Francisco parameters
  var map = new L.Map('map').setView([37.7724, -122.3617], 11 ); 

  // CartoDB Positron map style
  var layer = L.tileLayer('http://{s}.basemaps.cartocdn.com/light_all/{z}/{x}/{y}.png', {
      attribution: '&copy; <a href="http://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors, &copy; <a href="http://cartodb.com/attributions">CartoDB</a>'
  });

  //var layer = new L.StamenTileLayer("toner");
  // Toner style, slightly modified to darken the background
  //var layer = new L.tileLayer("http://{s}.sm.mapstack.stamen.com/(toner-lite,$fff[difference],$666[@23],$fff[hsl-saturation@20])/{z}/{x}/{y}.png");
  
  map.addLayer(layer);
  map.scrollWheelZoom.disable();

  var svg = d3.select(map.getPanes().overlayPane).append("svg"),
      g = svg.append("g").attr("class", "leaflet-zoom-hide");

  queue()
      .defer(d3.json, "geo/sfbact.json")
      //.defer(d3.json, "../geo/SFhoods.json")
      .defer(d3.csv, "data/thclust/"+currentLinkage+"/"+currentNClass+"/sfbact-clusters-2014.csv")
      .await(ready);

  function ready(error, tracts, clusters) {
    clusters.forEach(function(d) {
          clusterById[d.Geo_FIPS] = +d.cluster;
      });

    var transform = d3.geo.transform({point: projectPoint}),
          path = d3.geo.path().projection(transform).pointRadius(4);

    var feature = g.selectAll("path")
        .data(tracts.features)
          .enter().append("path")
        .attr("cluster", function(d){
          return "cl"+clusterById[+d.properties.GEOID];
        })
        .attr("class", "tracts")
        .style("fill", function(d){
          switch(clusterById[+d.properties.GEOID]) {
                case 1: return colors[0]; break;
                case 2: return colors[1]; break;
                case 3: return colors[2]; break;
                case 4: return colors[3]; break;
                case 5: return colors[4]; break;
                case 6: return colors[5]; break;
                case 7: return colors[6]; break;
                case 8: return colors[7]; break;
                case 9: return colors[8]; break;
                case 10: return colors[9]; break;
                case 11: return colors[10]; break;
                case 12: return colors[11]; break;
                case 13: return colors[12]; break;
                case 14: return colors[13]; break;
                case 15: return colors[14]; break;
              }
      })
      .on("mouseover", function(d){
        //d3.select(".legend.cluster").text(clusterById[+d.properties.GEOID]); // display the cluster number in the legend block
        currentCluster = clusterById[+d.properties.GEOID];

        d3.selectAll(".cl-label").style("opacity", .3);
        d3.select(".cl-label.cl"+clusterById[+d.properties.GEOID]).style("opacity", 1);
        d3.json("data/radar/thclust/"+currentLinkage+"/"+currentNClass+"/radar-"+currentYear+"-cl"+currentCluster+".json", function(data){
              var radarChartOptions = {color:colors[(currentCluster-1)]};
              RadarChart("#radarChart", data, radarChartOptions);
            })

      });

    map.on("viewreset", reset);
    reset();

    // Reposition the SVG to cover the features.
    function reset() {
        var bounds = path.bounds(tracts),
            topLeft = bounds[0],
            bottomRight = bounds[1];

        svg.attr("width", bottomRight[0] - topLeft[0])
            .attr("height", bottomRight[1] - topLeft[1])
            .style("left", topLeft[0] + "px")
            .style("top", topLeft[1] + "px");

        g.attr("transform", "translate(" + -topLeft[0] + "," + -topLeft[1] + ")");

        feature.attr("d", path);
    }

    // Use Leaflet to implement a D3 geometric transformation.
    function projectPoint(x, y) {
        var point = map.latLngToLayerPoint(new L.LatLng(y, x));
        this.stream.point(point.x, point.y);
      }
  } // function ready()


  ////////////////////////////////////////////////////////////////////
  // UPDATE FUNCTIONS ////////////////////////////////////////////////

  function update_map_clusters(error, tracts, clusters) {
    clusters.forEach(function(d) {
          clusterById[d.Geo_FIPS] = +d.cluster;
      });
    g.selectAll("path")
        .data(tracts.features)
    .transition()
    .duration(0)
    .attr("cluster", function(d){
          return "cl"+clusterById[+d.properties.GEOID];
      })
    .style("fill", function(d){
        switch(clusterById[+d.properties.GEOID]) {
              case 1: return colors[0]; break;
              case 2: return colors[1]; break;
              case 3: return colors[2]; break;
              case 4: return colors[3]; break;
              case 5: return colors[4]; break;
              case 6: return colors[5]; break;
              case 7: return colors[6]; break;
              case 8: return colors[7]; break;
              case 9: return colors[8]; break;
              case 10: return colors[9]; break;
              case 11: return colors[10]; break;
              case 12: return colors[11]; break;
              case 13: return colors[12]; break;
              case 14: return colors[13]; break;
              case 15: return colors[14]; break;

            }
    })
    //.each("end", update_map_opacity) // to foolow a cluster over years based on opacity (VERY SLOW)
    ;
  } // update_map_clusters()

  function update_map_variables(error, tracts, variables) {
    // currentVariable !!!!!!!
    var colorScale = d3.scale.threshold()
        .range(variable_color_scale)
        .domain(variable_domain)
        //.interpolate(d3.interpolateLab)
        ;

    variables.forEach(function(d) {
          variablesById[d.Geo_FIPS] = +d[currentVariable];
      });
    //console.log(variablesById[]);
    g.selectAll("path")
        .data(tracts.features)
    .transition()
    .duration(0)
    .style("fill", function(d){
      return colorScale(variablesById[+d.properties.GEOID]); 
    })
    .style("opacity", 1);
  } // update_map_variables

  function update_map_opacity(){ // opacity of tracts on the map
    if (opacity=="on") {
      //console.log("update_map_opacity going on");
      d3.selectAll("path.tracts").style("fill-opacity", 0.2);
      d3.selectAll("[cluster=cl"+(currentCluster)+"]").style("fill-opacity", 0.8);
      //console.log(currentCluster);
    }
  } // update_map_opacity()

  function resetMapOpacity() {
    d3.selectAll("path.tracts").style("fill-opacity", 0.8);
  }

  //Taken from http://bl.ocks.org/mbostock/7555321
  //Wraps SVG text  
  function wrap(text, width) {
    text.each(function() {
    var text = d3.select(this),
      words = text.text().split(/\s+/).reverse(),
      word,
      line = [],
      lineNumber = 0,
      lineHeight = 1.4, // ems
      y = text.attr("y"),
      x = text.attr("x"),
      dy = parseFloat(text.attr("dy")),
      tspan = text.text(null).append("tspan").attr("x", x).attr("y", y).attr("dy", dy + "em");
      
    while (word = words.pop()) {
      line.push(word);
      tspan.text(line.join(" "));
      if (tspan.node().getComputedTextLength() > width) {
      line.pop();
      tspan.text(line.join(" "));
      line = [word];
      tspan = text.append("tspan").attr("x", x).attr("y", y).attr("dy", ++lineNumber * lineHeight + dy + "em").text(word);
      }
    }
    });
  }//wrap 

  //////////////////////////////////////////////////
  // INTERACTION WITH MAIN MENU ////////////////////

  d3.select(".btn-clusters") // CLUSTERS DISPLAY
    .on("click", function(){
      $(".btn-display[value="+currentDisplay+"]").button("toggle");
      currentDisplay = "clusters";
      $(this).button("toggle");
      $("#variable-legend-label").hide();
      $("#variable-legend-color-scale").hide();
      $("#distributionPlot").hide();
      $("#cluster-legend-label").show();
      $("#radarChart").show();
      queue()
          .defer(d3.json, "geo/sfbact.json")
          .defer(d3.csv, "data/thclust/"+currentLinkage+"/"+currentNClass+"/sfbact-clusters-"+currentYear+".csv")
          .await(update_map_clusters);
    });
  d3.select(".btn-variables") // VARIABLES DISPLAY
    .on("click", function(){
      $(".btn-display[value="+currentDisplay+"]").button("toggle");
      currentDisplay = "variables";
      $(this).button("toggle");
      resetMapOpacity();
      $("#cluster-legend-label").hide();
      $("#radarChart").hide();
      $("#variable-legend-label").show();
      $("#variable-legend-color-scale").show();
      $("#distributionPlot").show();
      queue()
          .defer(d3.json, "geo/sfbact.json")
          .defer(d3.csv, "data/var/thclust/"+currentLinkage+"/"+currentNClass+"/sfbact-var-"+currentYear+".csv")
          .await(update_map_variables);
    });
  d3.selectAll(".btn-years") // YEAR CHOICE
    .on("click", function(d){
      $(".btn-years[value="+currentYear+"]").button("toggle");
      $(this).button("toggle");
      resetMapOpacity();
      currentYear = this.value;
      // Update Radar chart
      d3.json("data/radar/thclust/"+currentLinkage+"/"+currentNClass+"/radar-"+currentYear+"-cl"+currentCluster+".json", function(data){
                var radarChartOptions = {color:colors[(currentCluster-1)]};
                RadarChart("#radarChart", data, radarChartOptions);
              });
      // Update variable view distribution plot
      d3.csv("data/var/thclust/"+currentLinkage+"/"+currentNClass+"/sfbact-var-"+currentYear+".csv", function(data) {
        distributionPlot("#distributionPlot", data);
      })
      if (currentDisplay == "clusters") {
        queue()
          .defer(d3.json, "geo/sfbact.json")
          .defer(d3.csv, "data/thclust/"+currentLinkage+"/"+currentNClass+"/sfbact-clusters-"+currentYear+".csv")
          .await(update_map_clusters);
      } else {
        queue()
          .defer(d3.json, "geo/sfbact.json")
          .defer(d3.csv, "data/var/thclust/"+currentLinkage+"/"+currentNClass+"/sfbact-var-"+currentYear+".csv")
          .await(update_map_variables);
      }
    });
    d3.selectAll(".btn-nclass") // NUMBER OF CLUSTERS
    .on("click", function(d){
      $(".btn-nclass[value="+currentNClass+"]").button("toggle");
      $(this).button("toggle");
      resetMapOpacity();
      currentNClass = this.value;
      // Update Radar chart
      d3.json("data/radar/thclust/"+currentLinkage+"/"+currentNClass+"/radar-"+currentYear+"-cl"+currentCluster+".json", function(data){
                var radarChartOptions = {color:colors[(currentCluster-1)]};
                RadarChart("#radarChart", data, radarChartOptions);
              });
      // Update variable view distribution plot
      d3.csv("data/var/thclust/"+currentLinkage+"/"+currentNClass+"/sfbact-var-"+currentYear+".csv", function(data) {
        distributionPlot("#distributionPlot", data);
      })
      if (currentDisplay == "clusters") {
        queue()
          .defer(d3.json, "geo/sfbact.json")
          .defer(d3.csv, "data/thclust/"+currentLinkage+"/"+currentNClass+"/sfbact-clusters-"+currentYear+".csv")
          .await(update_map_clusters);
      } else {
        queue()
          .defer(d3.json, "geo/sfbact.json")
          .defer(d3.csv, "data/var/thclust/"+currentLinkage+"/"+currentNClass+"/sfbact-var-"+currentYear+".csv")
          .await(update_map_variables);
      }
    });
    d3.selectAll(".btn-linkage") // HCLUST LINKAGE
    .on("click", function(d){
      $(".btn-linkage[value="+currentLinkage+"]").button("toggle");
      $(this).button("toggle");
      resetMapOpacity();
      currentLinkage = this.value;
      // Update Radar chart
      d3.json("data/radar/thclust/"+currentLinkage+"/"+currentNClass+"/radar-"+currentYear+"-cl"+currentCluster+".json", function(data){
                var radarChartOptions = {color:colors[(currentCluster-1)]};
                RadarChart("#radarChart", data, radarChartOptions);
              });
      // Update variable view distribution plot
      d3.csv("data/var/thclust/"+currentLinkage+"/"+currentNClass+"/sfbact-var-"+currentYear+".csv", function(data) {
        distributionPlot("#distributionPlot", data);
      })
      if (currentDisplay == "clusters") {
        queue()
          .defer(d3.json, "geo/sfbact.json")
          .defer(d3.csv, "data/thclust/"+currentLinkage+"/"+currentNClass+"/sfbact-clusters-"+currentYear+".csv")
          .await(update_map_clusters);
      } else {
        queue()
          .defer(d3.json, "geo/sfbact.json")
          .defer(d3.csv, "data/var/thclust/"+currentLinkage+"/"+currentNClass+"/sfbact-var-"+currentYear+".csv")
          .await(update_map_variables);
      }
    });

  //////////////////////////////////////////////////
  // RADAR PLOT ////////////////////////////////////

  var radarChartOptions = {
        maxValue: 1,
        levels: 4,
        roundStrokes: false,
        color:"#18154C"
    };
  //Call function to draw the Radar chart
  d3.json("data/radar/thclust/"+currentLinkage+"/"+currentNClass+"/radar-2014-cl1.json", function(data){
    RadarChart("#radarChart", data, radarChartOptions);
  })

  //////////////////////////////////////////////////
  // SANKEY DIAGRAM ////////////////////////////////
  /*d3.json("data/sankey/sankey.json", function(data){
    sankeyDiagram("#sankey", data)
  })*/

  // LEGEND ////////////////////////////////////////
  var cluster_legend_color = d3.select("#cluster-legend-color").append("svg").attr("height", 400).append("g");
  var cluster_legend_label = d3.select("#cluster-legend-label").append("svg").attr("height", 400).append("g").attr("class", "svg-cl-legend-label");
  var variable_legend_label = d3.select("#variable-legend-label").append("svg").attr("height", 450).append("g");
  var variable_legend_color_scale = d3.select("#variable-legend-color-scale").append("svg").attr("height", 50).append("g");
  
  cluster_legend_label
    .selectAll("text")
      .data(clusters_labels)
        .enter()
        .append("text")
          .attr("class", function(d,i) { return "cl-label cl"+(i+1);})
          .attr("x", 0)
          .attr("y", function(d,i){return (i+0.7)*18;})
          .attr("dy", "0.35em")
          .style("fill", function(d, i) {return colors[i];})
          .text(function(d){return d;})
          .on("mouseover", function(d,i){
              opacity = "on";
              currentCluster = i+1;
              update_map_opacity();
              d3.json("data/radar/thclust/"+currentLinkage+"/"+currentNClass+"/radar-"+currentYear+"-cl"+(i+1)+".json", function(data){
                var radarChartOptions = {color:colors[i]};
                RadarChart("#radarChart", data, radarChartOptions);
              })
              d3.selectAll(".cl-label").style("opacity", .3);
              d3.select(this).style("opacity", 1);
            })

        //.call(wrap, 200)
          //.on("click", function(){update_map_opacity()})
          /*.on("mouseout", function() {
            d3.selectAll("path").style("fill-opacity", 0.7);
          })*/; 
    /*d3.select(".svg-cl-legend-label")
      .on("mouseout", function() {
            d3.selectAll("path").style("fill-opacity", 0.7);
          });*/

  variable_legend_label
    .selectAll("text")
      .data(variables_names)
        .enter()
        .append("text")
        .attr("class", function(d) {return "var-label "+d;})
        .attr("x", 0)
        .attr("y", function(d, i) {return (i+0.7)*18})
        .text(function(d, i){return variables_labels[i];})
        .on("click",  function(d, i){
          currentVariable = variables_names[i];
          d3.selectAll(".var-label").style("opacity", .3);
          d3.select(this).style("opacity", 1);
          d3.csv("data/var/thclust/"+currentLinkage+"/"+currentNClass+"/sfbact-var-"+currentYear+".csv", function(data) {
            distributionPlot("#distributionPlot", data);
          })
          queue()
            .defer(d3.json, "geo/sfbact.json")
            .defer(d3.csv, "data/var/thclust/"+currentLinkage+"/"+currentNClass+"/sfbact-var-"+currentYear+".csv")
            .await(update_map_variables);
        });

  variable_legend_color_scale
    .selectAll("rect")
    .data(variable_color_scale)
      .enter()
      .append("rect")
      //.attr("class", "legend-color-scale")
      .attr("x", function(d,i){return i*30;})
      .attr("y", 0)
      .attr("width", 30)
      .attr("height", 16)
      .style("fill", function(d){return d;});
  variable_legend_color_scale
    .selectAll("text")
      .data(variable_domain)
        .enter()
        .append("text")
        .attr("x", function(d,i){
          return ((i*30)+30);
        })
        .attr("y", 30)
        .text(function(d) {return Format(d);});

  //////////////////////////////////////////////////////////////////////       
  // DISTRIBUTION CHART ////////////////////////////////////////////////

  function distributionPlot(id, data) {
    var PCScale = d3.scale.linear()
          .domain([0,1])
          .range([0,300]);

    d3.select(id).select("svg").remove();

    var svg = d3.select(id).append("svg")
      .attr("width",  300)
      .attr("height", 250)
      .attr("class", "distributionPlot");

    svg.selectAll("circle")
      .data(data)
        .enter()
        .append("circle")
          .attr("class", "DistPlotCircle")
          .attr("cx", function(d) {
            return PCScale(+d[currentVariable]);
          })
          .attr("cy", function(d) {
            return +d.cluster*15;
          })
          .attr("r", 3)
          .style("fill", function(d) {
            switch(+d.cluster) {
              case 1: return colors[0]; break;
              case 2: return colors[1]; break;
              case 3: return colors[2]; break;
              case 4: return colors[3]; break;
              case 5: return colors[4]; break;
              case 6: return colors[5]; break;
              case 7: return colors[6]; break;
              case 8: return colors[7]; break;
              case 9: return colors[8]; break;
              case 10: return colors[9]; break;
              case 11: return colors[10]; break;
              case 12: return colors[11]; break;
              case 13: return colors[12]; break;
              case 14: return colors[13]; break;
              case 15: return colors[14]; break;

            }
          })
          .style("fill-opacity", 0.5)
          .style("stroke", function(d) {
            switch(+d.cluster) {
              case 1: return colors[0]; break;
              case 2: return colors[1]; break;
              case 3: return colors[2]; break;
              case 4: return colors[3]; break;
              case 5: return colors[4]; break;
              case 6: return colors[5]; break;
              case 7: return colors[6]; break;
              case 8: return colors[7]; break;
              case 9: return colors[8]; break;
              case 10: return colors[9]; break;
              case 11: return colors[10]; break; 
              case 12: return colors[11]; break;
              case 13: return colors[12]; break;
              case 14: return colors[13]; break;
              case 15: return colors[14]; break;

            }
          })
          .on("mouseover", function(d) {
            console.log(clusters_labels[(+d.cluster-1)]);
          });
  }

  d3.csv("data/var/thclust/"+currentLinkage+"/"+currentNClass+"/sfbact-var-"+currentYear+".csv", function(data) {
    distributionPlot("#distributionPlot", data);
  })

  // hide 'variables' display divs.
  $("#variable-legend-label").hide();
  $("#variable-legend-color-scale").hide();
  $("#distributionPlot").hide();

  // Initial display of the variable One Unit // totally random
  d3.selectAll(".var-label").style("opacity", .3);
  d3.selectAll(".var-label.PCcommutingNotCar").style("opacity", 1);

  </script>
  <script src="https://ajax.googleapis.com/ajax/libs/jquery/1.11.3/jquery.min.js"></script>
  <script src="layout/bootstrap-3.3.6-dist/js/bootstrap.min.js"></script>
</body>
</html>