<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1">

    <title>SFBA OAC</title>
    <!-- Bootstrap -->
    <link href="layout/bootstrap-3.3.6-dist/css/bootstrap.min.css" rel="stylesheet">
    <!-- leaflet -->
    <link rel="stylesheet" href="layout/leaflet-0.7.3/leaflet.css" />
    <script src="layout/leaflet-0.7.3/leaflet.js"></script>
    <!-- d3 and plugins -->
    <script src="layout/d3-master/d3.min.js"></script>
    <script src="layout/queue.js"></script>
    <script src="layout/topojson.js"></script>
    <script src="layout/radarPlot.js"></script>
    <script src="layout/sankey.js"></script>
    <!-- custom css -->
    <link rel="stylesheet" href="layout/css/main.css" /> 
    <link rel="stylesheet" href="layout/css/sankey.css" />   
  </head>
  <body>
  
  <div class="container">
    <h1>Bay Area Geodemographics<br><small>Tracking change in San Francisco Bay Area Neighborhoods</small></h1>
  </div>
  
  <div class="container">
    <div class="row">
      <div class="col-xs-7">
        <div id="map"></div>
      </div>
      <div class="col-xs-5">
        <div class="row">
          <!-- <ul class="nav nav-tabs">
            <li role="presentation" class="active"><a href="#">Clusters</a></li>
            <li role="presentation"><a href="#">Change</a></li>
            <li role="presentation"><a href="#">Raw variables</a></li>
          </ul> -->
        </div>
        <div class="row">
          <div class="col-xs-12">
            <div id="radarChart"></div>
          </div>
        </div>
        <div class="row">
          <div class="col-xs-1">
            <div id="cluster-legend-color"></div>
          </div>
          <div class="col-xs-11">
            <div id="cluster-legend-label"></div>
          </div>
        </div>
        
      </div>
    </div>
    <div class="row">
      <div class="col-xs-7">
        <div id="sankey"></div>
      </div>
      <div class="col-xs-5">
      </div>
    </div>
  </div>

  <script>
  // Initial layer to be displayed
  var currentYear = "2014";
  var clusterById = {};
  var currentCluster = 0;
  var opacity = "off";
  var years = ["2009","2010","2011","2012","2013","2014"];
  var colors = ["#18154C","#EC501C","#7F1B4F","#005C37","#1A86C3","#E71584","#4F3089","#FEF30C","#E6211C","#17ABA1"];
  var clusters_labels = ["1. Wealthy Surbanites", "2. Urban Diversity", "3. Working Urbanites", "4. Struggling Urbanites", "5. Secluded Urbanites", "6. Young and Lively Urbanites", "7. Subarbanites", "8. Remote Surbanites", "9. Berkeley", "10. Weird Cluster"];

  // Bay Area parameters
  //var map = new L.Map('map').setView([37.8082, -122.2668], 10 ); 

  // San Francisco parameters
  var map = new L.Map('map').setView([37.7724, -122.3617], 12 ); 

  // CartoDB Positron map style
  var layer = L.tileLayer('http://{s}.basemaps.cartocdn.com/light_only_labels/{z}/{x}/{y}.png', {
      attribution: '&copy; <a href="http://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors, &copy; <a href="http://cartodb.com/attributions">CartoDB</a>'
  });

  //var layer = new L.StamenTileLayer("toner");
  // Toner style, slightly modified to darken the background
  //var layer = new L.tileLayer("http://{s}.sm.mapstack.stamen.com/(toner-lite,$fff[difference],$666[@23],$fff[hsl-saturation@20])/{z}/{x}/{y}.png");
  
  map.addLayer(layer);
  map.scrollWheelZoom.disable();

  var svg = d3.select(map.getPanes().overlayPane).append("svg"),
      g = svg.append("g").attr("class", "leaflet-zoom-hide"),
      legend = d3.select("#div-legend");

  queue()
      .defer(d3.json, "geo/sfbact.json")
      //.defer(d3.json, "../geo/SFhoods.json")
      .defer(d3.csv, "data/hclust/sfbact-clusters-2014.csv")
      .await(ready);

    function ready(error, tracts, clusters) {
    clusters.forEach(function(d) {
          clusterById[d.Geo_FIPS] = +d.cluster;
      });

    var transform = d3.geo.transform({point: projectPoint}),
          path = d3.geo.path().projection(transform).pointRadius(4);

    var feature = g.selectAll("path")
        .data(tracts.features)
          .enter().append("path")
        .attr("cluster", function(d){
          return "cl"+clusterById[+d.properties.GEOID];
        })
        .attr("class", "tracts")
        .style("fill", function(d){
          switch(clusterById[+d.properties.GEOID]) {
                case 1: return colors[0]; break;
                case 2: return colors[1]; break;
                case 3: return colors[2]; break;
                case 4: return colors[3]; break;
                case 5: return colors[4]; break;
                case 6: return colors[5]; break;
                case 7: return colors[6]; break;
                case 8: return colors[7]; break;
                case 9: return colors[8]; break;
                case 10: return colors[9]; break;
              }
      })
      .on("mouseover", function(d){
        //d3.select(".legend.cluster").text(clusterById[+d.properties.GEOID]); // display the cluster number in the legend block
        d3.selectAll(".cl-label").style("opacity", .3);
        d3.select(".cl-label.cl"+clusterById[+d.properties.GEOID]).style("opacity", 1);
        d3.json("data/radar/radar-cl"+clusterById[+d.properties.GEOID]+".json", function(data){
              RadarChart("#radarChart", data, radarChartOptions);
            })

      });

    map.on("viewreset", reset);
    reset();

    // Reposition the SVG to cover the features.
    function reset() {
        var bounds = path.bounds(tracts),
            topLeft = bounds[0],
            bottomRight = bounds[1];

        svg.attr("width", bottomRight[0] - topLeft[0])
            .attr("height", bottomRight[1] - topLeft[1])
            .style("left", topLeft[0] + "px")
            .style("top", topLeft[1] + "px");

        g.attr("transform", "translate(" + -topLeft[0] + "," + -topLeft[1] + ")");

        feature.attr("d", path);
    }

    // Use Leaflet to implement a D3 geometric transformation.
    function projectPoint(x, y) {
        var point = map.latLngToLayerPoint(new L.LatLng(y, x));
        this.stream.point(point.x, point.y);
      }
    }

  function update_map(error, tracts, clusters) {
    clusters.forEach(function(d) {
          clusterById[d.Geo_FIPS] = +d.cluster;
      });
      g.selectAll("path")
        .data(tracts.features)
    .transition()
    .duration(0)
    .attr("cluster", function(d){
          return "cl"+clusterById[+d.properties.GEOID];
      })
    .style("fill", function(d){
        switch(clusterById[+d.properties.GEOID]) {
              case 1: return colors[0]; break;
              case 2: return colors[1]; break;
              case 3: return colors[2]; break;
              case 4: return colors[3]; break;
              case 5: return colors[4]; break;
              case 6: return colors[5]; break;
              case 7: return colors[6]; break;
              case 8: return colors[7]; break;
              case 9: return colors[8]; break;
              case 10: return colors[9]; break;
            }
    })
    .each("end", update_cluster_map)
    ;
  }

  function update_cluster_map(){
    if (opacity=="on") {
      //console.log("update_cluster_map going on");
      d3.selectAll("path").style("fill-opacity", 0.2);
      d3.selectAll("[cluster=cl"+(currentCluster)+"]").style("fill-opacity", 0.7);
      //console.log(currentCluster);
    }
  }

  //////////////////////////////////////////////////
  // RADAR PLOT ////////////////////////////////////

  var radarChartOptions = {
        w: 350,
        h: 250,
        maxValue: 1,
        levels: 4,
        roundStrokes: false,
    };
  //Call function to draw the Radar chart
  d3.json("data/radar/radar-dev-cl1.json", function(data){
    RadarChart("#radarChart", data, radarChartOptions);
  })

  //////////////////////////////////////////////////
  // SANKEY DIAGRAM ////////////////////////////////
  d3.json("data/sankey/sankey.json", function(data){
    sankeyDiagram("#sankey", data)
  })

  // LEGEND ////////////////////////////////////////

  // d3.selectAll(".cluster-legend-color")
  //   .on
  //var svg_legend = d3.select("#div-legend").append("svg").attr("height", 300);
  var cluster_legend_color = d3.select("#cluster-legend-color").append("svg").attr("height", 200).append("g");
  var cluster_legend_label = d3.select("#cluster-legend-label").append("svg").attr("height", 200).append("g");
  //var g_legendcolors = svg_legend.append("g").attr("class", "legendcolors");
  //var g_legendyears = svg_legend.append("g").attr("class", "legendyears");
  // var g_legendhood = svg_legend.append("g").attr("class", "legendhood");
  // var g_legendcluster = svg_legend.append("g").attr("class", "legendcluster");
  // var g_legendreset = svg_legend.append("g").attr("class", "legendreset");
  
  cluster_legend_color
    .selectAll("rect")
      .data(colors)
        .enter()
        .append("svg:rect")
        .attr("class", "class")
        .attr("y", function(d,i){return i*18;})
        .attr("x", 0)
        .attr("width", 30)
        .attr("height", 16)
        .style("fill", function(d){return d;})
        .style("opacity", .7)
        .on("mouseover", function(d,i){
          opacity = "on";
          currentCluster = i+1;
          update_cluster_map();
          d3.json("data/radar/radar-cl"+(i+1)+".json", function(data){
              RadarChart("#radarChart", data, radarChartOptions);
            })
          d3.selectAll(".cl-label").style("opacity", .3);
          d3.select(".cl-label.cl"+(i+1)).style("opacity", 1);
        }); 
  cluster_legend_label
    .selectAll("text")
      .data(clusters_labels)
        .enter()
        .append("text")
          .attr("class", function(d,i) { return "cl-label cl"+(i+1);})
          .attr("y", function(d,i){return (i+0.7)*18;})
          .attr("x", 10)
          .text(function(d){return d;})
          .on("mouseover", function(d,i){
              opacity = "on";
              currentCluster = i+1;
              update_cluster_map();
              d3.json("data/radar/radar-cl"+(i+1)+".json", function(data){
                RadarChart("#radarChart", data, radarChartOptions);
              })
              d3.selectAll(".cl-label").style("opacity", .3);
              d3.select(this).style("opacity", 1);
            }); 
  
  // colorsrect.data(colors)
  //   .enter()
  //   .append("text")
  //   .attr("x", function(d,i){return (i*30)+2;})
  //     .attr("y", 45)
  //     .text(function(d,i){return i+1;});

  // g_legendhood.append("text").attr("class", "legend hood").attr("x",0).attr("y", 125).text("Cluster :");
  // g_legendcluster.append("text").attr("class", "legend cluster").attr("x",0).attr("y", 145).text("cluster");
  // g_legendreset.append("text").attr("x",0).attr("y", 13).text("reset opacity").on("click", function(){
  //   d3.selectAll("path").style("fill-opacity", 0.7)
  //   // .on("mouseover", function(){
  //   //  d3.selectAll("path").style("fill-opacity", 0.7); 
  //   //  d3.select(this).style("fill-opacity", 0.2);
  //   // })
  //   ;
  //   opacity = "off";
  // });

  </script>









    <!-- <ul class="list-group">
              <li class="list-group-item">
                <svg height="16px">
                  <rect class = "cluster-legend-color" id = "cl-1" width="30" height="16"></rect>
                  <text y="12" x="40">1. Wealthy Surbanites</text>
                </svg>
              </li>
              <li class="list-group-item">
                <svg height="16px">
                  <rect class = "cluster-legend-color" id = "cl-2" width="30" height="16"></rect>
                  <text y="12" x="40">2. Urban Diversity</text>
                </svg>
              </li><li class="list-group-item">
                <svg height="16px">
                  <rect class = "cluster-legend-color" id = "cl-3" width="30" height="16"></rect>
                  <text y="12" x="40">3. Working Urbanites</text>
                </svg>
              </li><li class="list-group-item">
                <svg height="16px">
                  <rect class = "cluster-legend-color" id = "cl-4" width="30" height="16"></rect>
                  <text y="12" x="40">4. Struggling Urbanites</text>
                </svg>
              </li><li class="list-group-item">
                <svg height="16px">
                  <rect class = "cluster-legend-color" id = "cl-5" width="30" height="16"></rect>
                  <text y="12" x="40">5. Secluded Urbanites</text>
                </svg>
              </li><li class="list-group-item">
                <svg height="16px">
                  <rect class = "cluster-legend-color" id = "cl-6" width="30" height="16"></rect>
                  <text y="12" x="40">6. Young and Lively Urbanites</text>
                </svg>
              </li><li class="list-group-item">
                <svg height="16px">
                  <rect class = "cluster-legend-color" id = "cl-7" width="30" height="16"></rect>
                  <text y="12" x="40">7. Subarbanites</text>
                </svg>
              </li><li class="list-group-item">
                <svg height="16px">
                  <rect class = "cluster-legend-color" id = "cl-8" width="30" height="16"></rect>
                  <text y="12" x="40">8. Remote Surbanites</text>
                </svg>
              </li><li class="list-group-item">
                <svg height="16px">
                  <rect class = "cluster-legend-color" id = "cl-9" width="30" height="16"></rect>
                  <text y="12" x="40">9. Berkeley</text>
                </svg>
              </li><li class="list-group-item">
                <svg height="16px">
                  <rect class = "cluster-legend-color" id = "cl-10" width="30" height="16"></rect>
                  <text y="12" x="40">10. Weird Cluster</text>
                </svg>
              </li>
            </ul> -->

    <script src="https://ajax.googleapis.com/ajax/libs/jquery/1.11.3/jquery.min.js"></script>
    <script src="layout/bootstrap-3.3.6-dist/js/bootstrap.min.js"></script>
  </body>
</html>